<div class="detailed-overlay" *ngIf="isVisible">
  <div  class="detailed-container" (click)="$event.stopPropagation()">
    <div class="header-actions">
      <button mat-icon-button class="close-button" (click)="close()" aria-label="Cerrar">
        <mat-icon>close</mat-icon>
      </button>
      <button mat-icon-button class="edit-button" *ngIf="currentItem?.editable && !isEditing && !addingNewItem" (click)="startEdit()" aria-label="Editar">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button class="edit-button" *ngIf="isEditing" (click)="saveEdit()" aria-label="Guardar" color="primary">
        <mat-icon>save</mat-icon>
      </button>
      <button mat-icon-button class="close-button" *ngIf="isEditing && !addingNewItem" (click)="cancelEdit()" aria-label="Cancelar" color="warn">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>

    <div class="navigation-header" *ngIf="showNavigation && data.length > 1 && !addingNewItem">
      <button mat-icon-button [disabled]="!canNavigatePrevious" (click)="navigatePrevious()" aria-label="Anterior">
        <mat-icon>chevron_left</mat-icon>
      </button>

      <span class="position-indicator">{{ currentPosition }}</span>

      <button mat-icon-button [disabled]="!canNavigateNext" (click)="navigateNext()" aria-label="Siguiente">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <mat-card *ngIf="currentItem && currentItem.editable" [formGroup]="currentItem.form!">
      <mat-card-title *ngIf="addingNewItem" class="add-title">Añadir nueva empresa</mat-card-title>
      <mat-card-title *ngIf="!isEditing">{{ currentItem.title }}</mat-card-title>

      <mat-card-header>

        <mat-form-field *ngIf="isEditing" appearance="outline" class="edit-field">
          <mat-label>{{currentItem.titleLabel}}</mat-label>
          <input matInput formControlName="login">
          <mat-error *ngIf="currentItem.form?.get('login')?.hasError('required')">
            El nombre de la empresa es obligatorio
          </mat-error>
          <mat-error *ngIf="currentItem.form?.get('login')?.hasError('minlength')">
            Mínimo 2 caracteres
          </mat-error>
          <mat-error *ngIf="currentItem.form?.get('login')?.hasError('maxlength')">
            Máximo 50 caracteres
          </mat-error>
        </mat-form-field>

        <mat-card-subtitle *ngIf="currentItem.subtitle && !isEditing">
          {{ currentItem.subtitle }}
        </mat-card-subtitle>

        <mat-form-field *ngIf="isEditing" appearance="outline" class="edit-field">
          <mat-label>{{currentItem.subtitleLabel}}</mat-label>
          <input matInput formControlName="email" type="email">
          <mat-error *ngIf="currentItem.form?.get('email')?.hasError('required')">
            El email es obligatorio
          </mat-error>
          <mat-error *ngIf="currentItem.form?.get('email')?.hasError('email')">
            Ingrese un email válido
          </mat-error>
        </mat-form-field>
      </mat-card-header>

      <mat-card-content [ngClass]="{'invisible': panelOpenState && currentItem.candidates && currentItem.candidates.length > 0}">
        <div *ngIf="!isEditing" [innerHTML]="currentItem.content"></div>

        <mat-form-field *ngIf="isEditing" appearance="outline" class="edit-field full-width">
          <mat-label>{{currentItem.contentLabel}}</mat-label>
          <textarea matInput formControlName="description" rows="4"></textarea>
          <mat-error *ngIf="currentItem.form?.get('description')?.hasError('required')">
            La descripción es obligatoria
          </mat-error>
          <mat-error *ngIf="currentItem.form?.get('description')?.hasError('minlength')">
            Mínimo 10 caracteres
          </mat-error>
          <mat-error *ngIf="currentItem.form?.get('description')?.hasError('maxlength')">
            Máximo 500 caracteres
          </mat-error>
        </mat-form-field>

        <div class="metadata" *ngIf="currentItem.metadata && !isEditing">
          <div *ngFor="let item of currentItem.metadata | keyvalue" class="metadata-item">
            <strong>{{ item.key.toUpperCase() }}:</strong> {{ item.value }}
          </div>
        </div>

        <div class="metadata-edit" *ngIf="isEditing && currentItem.form">
          <h4>Información adicional:</h4>

          <div class="metadata-edit-item">
            <mat-form-field appearance="outline" class="metadata-value">
              <mat-label>Teléfono</mat-label>
              <input matInput formControlName="phone">
              <mat-error *ngIf="currentItem.form?.get('phone')?.hasError('required')">
                El teléfono es obligatorio
              </mat-error>
              <mat-error *ngIf="currentItem.form?.get('phone')?.hasError('pattern')">
                Formato de teléfono inválido
              </mat-error>
            </mat-form-field>
          </div>

          <div class="metadata-edit-item">
            <mat-form-field appearance="outline" class="metadata-value">
              <mat-label>Sitio Web</mat-label>
              <input matInput formControlName="url">
              <mat-error *ngIf="currentItem.form?.get('url')?.hasError('required')">
                La URL es obligatoria
              </mat-error>
              <mat-error *ngIf="currentItem.form?.get('url')?.hasError('pattern')">
                Debe comenzar con http:// o https://
              </mat-error>
            </mat-form-field>
          </div>

          <div class="metadata-edit-item">
            <mat-form-field appearance="outline" class="metadata-value">
              <mat-label>Dirección</mat-label>
              <input matInput formControlName="address">
              <mat-error *ngIf="currentItem.form?.get('address')?.hasError('required')">
                La dirección es obligatoria
              </mat-error>
              <mat-error *ngIf="currentItem.form?.get('address')?.hasError('minlength')">
                Mínimo 5 caracteres
              </mat-error>
            </mat-form-field>
          </div>

          <div class="metadata-edit-item">
            <mat-form-field appearance="outline" class="metadata-value">
              <mat-label>Año de Fundación</mat-label>
              <input matInput formControlName="foundedDate" type="number">
              <mat-error *ngIf="currentItem.form?.get('foundedDate')?.hasError('required')">
                El año de fundación es obligatorio
              </mat-error>
              <mat-error *ngIf="currentItem.form?.get('foundedDate')?.hasError('min')">
                Año mínimo: 1800
              </mat-error>
              <mat-error *ngIf="currentItem.form?.get('foundedDate')?.hasError('max')">
                Año máximo: 2025</mat-error>
            </mat-form-field>
          </div>

          <div class="metadata-edit-item">
            <mat-form-field appearance="outline" class="metadata-value">
              <mat-label>URL del Logo</mat-label>
              <input matInput formControlName="logo">
            </mat-form-field>
          </div>
        </div>
      </mat-card-content>

      <mat-expansion-panel #expPanel (opened)="panelOpenState=true" (closed)="panelOpenState=false" class="candidates-panel"
        *ngIf="currentItem.candidates && currentItem.candidates.length > 0" [expanded]="panelOpenState">
        <mat-expansion-panel-header>
          <mat-panel-title>Candidatos ({{ currentItem.candidates.length}})</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="candidates-container">
          <ul class="candidates-list">
            <li *ngFor="let candidate of currentItem.candidates"
              [ngClass]="candidate.valid === true ? 'validated' : (candidate.valid === false ? 'rejected' : '')">
              <div class="candidate-info">
                <strong>Nombre:</strong> {{candidate.name}} {{candidate.surname1}} {{candidate.surname2}}<br>
                <strong>Email:</strong> {{candidate.email}}<br>
                <strong>Teléfono:</strong> {{candidate.phoneNumber}}<br>
                <strong>Fecha de registro:</strong> {{candidate.date}}
              </div>
              <div class="candidate-actions" *ngIf="!isEditing">
                <button mat-icon-button class="undo" *ngIf="candidate.valid !== null"
                  (click)="deleteOptionCandidate(candidate)"><mat-icon>undo</mat-icon></button>
                <button mat-icon-button class="check" *ngIf="candidate.valid !== true"
                  (click)="aceptCandidate(candidate)"><mat-icon>check</mat-icon></button>
                <button mat-icon-button class="close" *ngIf="candidate.valid !== false"
                  (click)="rejectCandidate(candidate)"><mat-icon>close</mat-icon></button>
              </div>
            </li>
          </ul>
        </div>
      </mat-expansion-panel>

      <mat-card-actions *ngIf="currentItem.actions && currentItem.actions.length > 0 && !isEditing">
        <button *ngFor="let action of currentItem.actions" mat-raised-button [color]="action.color || 'primary'"
          (click)="executeAction(action)">
          <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
          {{ action.label }}
        </button>
      </mat-card-actions>
    </mat-card>

    <mat-card *ngIf="currentItem && !currentItem.editable">
      <mat-card-title >{{ currentItem.title }}</mat-card-title>
      <mat-card-header>
        <mat-card-subtitle *ngIf="currentItem.subtitle">
          {{ currentItem.subtitle }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content [ngClass]="{'invisible': panelOpenState && currentItem.candidates && currentItem.candidates.length > 0}">
        <div [innerHTML]="currentItem.content"></div>

        <div class="metadata" *ngIf="currentItem.metadata">
          <div *ngFor="let item of currentItem.metadata | keyvalue" class="metadata-item">
            <strong>{{ item.key.toUpperCase() }}:</strong> {{ item.value }}
          </div>
        </div>
      </mat-card-content>

      <mat-expansion-panel
        #expPanel
        (opened)="panelOpenState=true"
        (closed)="panelOpenState=false; resetPanelScroll()"
        class="candidates-panel"
        *ngIf="currentItem.candidates && currentItem.candidates.length > 0"
        [expanded]="panelOpenState">
        <mat-expansion-panel-header>
          <mat-panel-title>Candidatos ({{ currentItem.candidates.length}})</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="candidates-container">
          <ul class="candidates-list">
            <li *ngFor="let candidate of currentItem.candidates"
              [ngClass]="candidate.valid === true ? 'validated' : (candidate.valid === false ? 'rejected' : '')">
              <div class="candidate-info">
                <strong>Nombre:</strong> {{candidate.name}} {{candidate.surname1}} {{candidate.surname2}}<br>
                <strong>Email:</strong> {{candidate.email}}<br>
                <strong>Teléfono:</strong> {{candidate.phoneNumber}}<br>
                <strong>Fecha de registro:</strong> {{candidate.date}}
              </div>
              <div class="candidate-actions" *ngIf="!isEditing">
                <button mat-icon-button class="undo" *ngIf="candidate.valid !== null"
                  (click)="deleteOptionCandidate(candidate)"><mat-icon>undo</mat-icon></button>
                <button mat-icon-button class="check" *ngIf="candidate.valid !== true"
                  (click)="aceptCandidate(candidate)"><mat-icon>check</mat-icon></button>
                <button mat-icon-button class="close" *ngIf="candidate.valid !== false"
                  (click)="rejectCandidate(candidate)"><mat-icon>close</mat-icon></button>
              </div>
            </li>
          </ul>
        </div>
      </mat-expansion-panel>

      <mat-card-actions *ngIf="currentItem.actions && currentItem.actions.length > 0 && !isEditing">
        <button *ngFor="let action of currentItem.actions" mat-raised-button [color]="action.color || 'primary'"
          (click)="executeAction(action)">
          <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
          {{ action.label }}
        </button>
      </mat-card-actions>
    </mat-card>


    <div class="navigation-dots" *ngIf="showNavigation && data.length > 1 && !addingNewItem">
      <button *ngFor="let item of data; let i = index" mat-icon-button class="dot" [class.active]="i === currentIndex"
        (click)="currentIndex = i; updateCurrentItem(); onNavigate.emit(currentIndex)">
        <div class="dot-indicator"></div>
      </button>
    </div>
  </div>
</div>
