<div class="detailed-overlay" *ngIf="isVisible">
  <div class="detailed-container" (click)="$event.stopPropagation()" >
    <div class="header-actions">
      <button mat-icon-button class="close-button" (click)="close()" aria-label="Cerrar">
        <mat-icon>close</mat-icon>
      </button>
      <button mat-icon-button class="edit-button" *ngIf="currentItem?.editable && !isEditing && !addingNewItem"
        (click)="startEdit()" aria-label="Editar">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button class="edit-button" *ngIf="isEditing" (click)="saveEdit()" aria-label="Guardar"
        color="primary">
        <mat-icon>save</mat-icon>
      </button>
      <button mat-icon-button class="close-button" *ngIf="isEditing && !addingNewItem" (click)="cancelEdit()"
        aria-label="Cancelar" color="warn">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>

    <div class="navigation-fixed-header" *ngIf="showNavigation && data.length > 1 && !addingNewItem">
      <mat-card-title *ngIf="!isEditing">{{ currentItem!.title.toUpperCase() }}</mat-card-title>
      <div class="navigation-controls">
        <button mat-icon-button [disabled]="!canNavigatePrevious" (click)="navigatePrevious()" aria-label="Anterior">
          <mat-icon>chevron_left</mat-icon>
        </button>

        <span class="position-indicator">{{ currentPosition }}</span>

        <button mat-icon-button [disabled]="!canNavigateNext" (click)="navigateNext()" aria-label="Siguiente">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>


    <div class="tabs-container" *ngIf="isCompany">
      <mat-tab-group [(selectedIndex)]="selectedTabIndex">
        <mat-tab label="Detalles">
          <div class="tab-content">
            <div class="card-content-wrapper">
              <mat-card *ngIf="currentItem && currentItem.editable" [formGroup]="currentItem.form!">
                <mat-card-title *ngIf="addingNewItem" class="add-title">Añadir nueva oferta</mat-card-title>
                <mat-card-header>
                  <mat-form-field *ngIf="isEditing" appearance="outline" class="edit-field">
                    <mat-label>{{currentItem.titleLabel}}</mat-label>
                    <input matInput formControlName="title">
                    <mat-error *ngIf="currentItem.form?.get('title')?.hasError('required')">
                      El título es obligatorio
                    </mat-error>
                    <mat-error *ngIf="currentItem.form?.get('title')?.hasError('minlength')">
                      Mínimo 3 caracteres
                    </mat-error>
                    <mat-error *ngIf="currentItem.form?.get('title')?.hasError('maxlength')">
                      Máximo 100 caracteres
                    </mat-error>
                  </mat-form-field>

                  <mat-card-subtitle *ngIf="currentItem.subtitle && currentItem.subtitle && !isEditing">
                    {{ currentItem.subtitle }}
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content
                  [ngClass]="{'invisible': panelOpenState && currentItem.candidates && currentItem.candidates.length > 0}">
                  <div *ngIf="!isEditing" [innerHTML]="currentItem.content"></div>

                  <mat-form-field *ngIf="isEditing" appearance="outline" class="edit-field">
                    <mat-label>{{currentItem.contentLabel}}</mat-label>
                    <textarea matInput formControlName="description" rows="3"></textarea>
                    <mat-error *ngIf="currentItem.form?.get('description')?.hasError('required')">
                      La descripción es obligatoria
                    </mat-error>
                    <mat-error *ngIf="currentItem.form?.get('description')?.hasError('minlength')">
                      Mínimo 10 caracteres
                    </mat-error>
                    <mat-error *ngIf="currentItem.form?.get('description')?.hasError('maxlength')">
                      Máximo 500 caracteres
                    </mat-error>
                  </mat-form-field>

                  <div *ngIf="isEditing && currentItem.form" class="tags-section">
                    <h4>Tags de la oferta (máximo 5)</h4>
                    <p class="tags-subtitle">Selecciona hasta 5 tags.</p>

                    <div class="selected-tags-count">
                      Tags seleccionados: {{getSelectedTagsCount(currentItem.form)}} / 5
                    </div>

                    <div class="tags-container">
                      <mat-chip-listbox class="tags-listbox" multiple
                        [formControl]="getTagsFormControl(currentItem.form)" [compareWith]="compareTagsById"
                        (selectionChange)="onChipSelectionChange($event)" (keydown)="onChipKeydown($event)">
                        <mat-chip-option *ngFor="let tag of availableTags" [value]="tag"
                          [class.chip-selected]="isTagSelected(tag, currentItem.form)"
                          [class.chip-unselected]="!isTagSelected(tag, currentItem.form)"
                          [disabled]="getSelectedTagsCount(currentItem.form) >= 5 && !isTagSelected(tag, currentItem.form)"
                          (keydown)="onChipKeydown($event)">
                          {{tag.name}}
                        </mat-chip-option>
                      </mat-chip-listbox>
                    </div>
                  </div>

                  <div class="metadata" *ngIf="currentItem.metadata && !isEditing">
                    <div *ngFor="let item of currentItem.metadata | keyvalue" class="metadata-item">
                      <strong *ngIf="item && item.key && item.value">{{ item.key.toUpperCase() }}:</strong> {{
                      item.value }}
                    </div>
                    <div *ngIf="currentItem.tags && currentItem.tags.length > 0 && !isEditing"
                      class="tags-section-static">
                      <h4>Areas de la oferta</h4>
                      <div class="tags-container">
                        <mat-chip-listbox class="tags-listbox" (keydown)="onChipKeydown($event)">
                          <mat-chip class="chip-info" *ngFor="let tag of currentItem.tags"
                            (click)="onChipClickHandler(tag)" (keydown)="onChipKeydown($event)">
                            {{tag.name}}
                          </mat-chip>
                        </mat-chip-listbox>
                      </div>
                    </div>
                  </div>
                </mat-card-content>
                <mat-card-actions *ngIf="currentItem.actions && currentItem.actions.length > 0 && !isEditing">
                  <button *ngFor="let action of currentItem.actions" mat-raised-button
                    [color]="action.color || 'primary'" (click)="executeAction(action)">
                    <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
                    {{ action.label }}
                  </button>
                </mat-card-actions>
              </mat-card>

              <mat-card *ngIf="currentItem && !currentItem.editable">
                <mat-card-title>{{ currentItem.title }}</mat-card-title>
                <mat-card-header>
                  <mat-card-subtitle *ngIf="currentItem.subtitle">
                    {{ currentItem.subtitle }}
                  </mat-card-subtitle>
                </mat-card-header>

                <mat-card-content
                  [ngClass]="{'invisible': panelOpenState && currentItem.candidates && currentItem.candidates.length > 0}">
                  <div [innerHTML]="currentItem.content"></div>
                  <div class="metadata" *ngIf="currentItem.metadata">
                    <div *ngIf="currentItem.tags && currentItem.tags.length > 0 && !isEditing "
                      class="tags-section-static">
                      <h4>Areas de la oferta</h4>
                      <div class="tags-container">
                        <mat-chip-listbox class="tags-listbox" (keydown)="onChipKeydown($event)">
                          <mat-chip class="chip-info" *ngFor="let tag of currentItem.tags"
                            (click)="onChipClickHandler(tag)" (keydown)="onChipKeydown($event)">
                            {{tag.name}}
                          </mat-chip>
                        </mat-chip-listbox>
                      </div>
                    </div>
                    <div *ngFor="let item of currentItem.metadata | keyvalue" class="metadata-item">
                      <strong>{{ item.key.toUpperCase() }}:</strong> {{ item.value }}
                    </div>
                  </div>
                </mat-card-content>

                <mat-card-actions *ngIf="currentItem.actions && currentItem.actions.length > 0 && !isEditing">
                  <button *ngFor="let action of currentItem.actions" mat-raised-button
                    [color]="action.color || 'primary'" (click)="executeAction(action)">
                    <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
                    {{ action.label }}
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Candidatos">
          <div class="tab-content">
            <div class="candidates-table-container">
              <table class="custom-table" *ngIf="!isLoadingCandidates">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let candidate of candidates" class="candidate-row"
                    (click)="navigateToCandidate(candidate.login)">
                    <td>{{ candidate.name }} {{ candidate.surname1 }} {{ candidate.surname2 }}</td>
                    <td>{{ candidate.email }}</td>
                    <td>{{ candidate.dateAdded | date:'dd/MM/yyyy' }}</td>
                    <td>
                      <div class="triple-toggle-container" (click)="$event.stopPropagation()">
                        <div class="triple-toggle" [ngClass]="'position-' + getTogglePosition(candidate.valid)">
                          <div class="toggle-track">
                            <div class="toggle-thumb">
                              <div class="toggle-thumb-icon" [ngClass]="{'active': candidate.valid === true}">
                                <mat-icon>check</mat-icon>
                              </div>
                              <div class="toggle-thumb-icon" [ngClass]="{'active': candidate.valid === null}">
                                <mat-icon>schedule</mat-icon>
                              </div>
                              <div class="toggle-thumb-icon" [ngClass]="{'active': candidate.valid === false}">
                                <mat-icon>close</mat-icon>
                              </div>
                            </div>
                            <div class="toggle-options">
                              <div class="toggle-option" (click)="onToggleChange(candidate, true)"
                                [ngClass]="{'active': candidate.valid === true}">
                              </div>
                              <div class="toggle-option" (click)="onToggleChange(candidate, null)"
                                [ngClass]="{'active': candidate.valid === null}">
                              </div>
                              <div class="toggle-option" (click)="onToggleChange(candidate, false)"
                                [ngClass]="{'active': candidate.valid === false}">
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>
                      <button mat-icon-button color="primary" matTooltip="Abrir chat"
                        (click)="$event.stopPropagation(); openChatWithCandidate(candidate)">
                        <mat-icon>chat</mat-icon>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>

              <div *ngIf="isLoadingCandidates" class="loading-container">
                <div class="loading-spinner"></div>
                <span>Cargando candidatos...</span>
              </div>

              <div *ngIf="totalCandidatesPages > 1" class="pagination-container">
                <button mat-icon-button [disabled]="!canNavigateCandidatesPrevious()" (click)="moveCandidatesPage(-1)"
                  matTooltip="Página anterior">
                  <mat-icon>chevron_left</mat-icon>
                </button>

                <span class="pagination-info">
                  Página {{ currentCandidatesPage + 1 }} de {{ totalCandidatesPages }}
                  ({{ totalCandidatesElements }} candidatos)
                </span>

                <button mat-icon-button [disabled]="!canNavigateCandidatesNext()" (click)="moveCandidatesPage(1)"
                  matTooltip="Página siguiente">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Recomendados">
          <div class="tab-content">
            <div class="candidates-table-container">

              <table class="custom-table" *ngIf="!isLoadingRecommended">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Tags coincidentes</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let candidate of recommendedCandidates" class="candidate-row">
                    <td>{{ candidate.name }} {{ candidate.surname1 }} {{ candidate.surname2 }}</td>
                    <td>{{ candidate.email }}</td>
                    <td>
                      <div class="coincident-tags-container">
                        <mat-chip *ngFor="let tag of candidate.coincidences" class="matching-tag">
                          {{ tag }}
                        </mat-chip>
                      </div>
                    </td>
                    <td>
                      <button mat-icon-button color="primary" matTooltip="Ver perfil" (click)="navigateToCandidate(candidate.login)">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-icon-button color="primary" matTooltip="Abrir chat"
                        (click)="$event.stopPropagation(); openChatWithCandidate(candidate)">
                        <mat-icon>chat</mat-icon>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>

              <div *ngIf="isLoadingRecommended" class="loading-container">
                <div class="loading-spinner"></div>
                <span>Cargando candidatos recomendados...</span>
              </div>

              <div *ngIf="totalRecommendedPages > 1" class="pagination-container">
                <button mat-icon-button [disabled]="!canNavigateRecommendedPrevious()" (click)="moveRecommendedPage(-1)"
                  matTooltip="Página anterior">
                  <mat-icon>chevron_left</mat-icon>
                </button>

                <span class="pagination-info">
                  Página {{ currentRecommendedPage + 1 }} de {{ totalRecommendedPages }}
                  ({{ totalRecommendedElements }} candidatos)
                </span>

                <button mat-icon-button [disabled]="!canNavigateRecommendedNext()" (click)="moveRecommendedPage(1)"
                  matTooltip="Página siguiente">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>

    <div class="card-content-wrapper" *ngIf="!isCompany">
      <mat-card *ngIf="currentItem && currentItem.editable" [formGroup]="currentItem.form!">
        <mat-card-title *ngIf="addingNewItem" class="add-title">Añadir nueva
          oferta</mat-card-title>
        <mat-card-title *ngIf="!isEditing">{{ currentItem.title }}</mat-card-title>

        <mat-card-header>

          <mat-form-field *ngIf="isEditing" appearance="outline" class="edit-field">
            <mat-label>{{currentItem.titleLabel}}</mat-label>
            <input matInput formControlName="title">
            <mat-error *ngIf="currentItem.form?.get('title')?.hasError('required')">
              El título es obligatorio
            </mat-error>
            <mat-error *ngIf="currentItem.form?.get('title')?.hasError('minlength')">
              Mínimo 3 caracteres
            </mat-error>
            <mat-error *ngIf="currentItem.form?.get('title')?.hasError('maxlength')">
              Máximo 100 caracteres
            </mat-error>
          </mat-form-field>

          <mat-card-subtitle *ngIf="currentItem.subtitle && currentItem.subtitle && !isEditing">
            {{ currentItem.subtitle }}
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content
          [ngClass]="{'invisible': panelOpenState && currentItem.candidates && currentItem.candidates.length > 0}">
          <div *ngIf="!isEditing" [innerHTML]="currentItem.content"></div>

          <mat-form-field *ngIf="isEditing" appearance="outline" class="edit-field">
            <mat-label>{{currentItem.contentLabel}}</mat-label>
            <textarea matInput formControlName="description" rows="3"></textarea>
            <mat-error *ngIf="currentItem.form?.get('description')?.hasError('required')">
              La descripción es obligatoria
            </mat-error>
            <mat-error *ngIf="currentItem.form?.get('description')?.hasError('minlength')">
              Mínimo 10 caracteres
            </mat-error>
            <mat-error *ngIf="currentItem.form?.get('description')?.hasError('maxlength')">
              Máximo 500 caracteres
            </mat-error>
          </mat-form-field>

          <div *ngIf="isEditing && currentItem.form" class="tags-section">
            <h4>Tags de la oferta (máximo 5)</h4>
            <p class="tags-subtitle">Selecciona hasta 5 tags.</p>

            <div class="selected-tags-count">
              Tags seleccionados: {{getSelectedTagsCount(currentItem.form)}} / 5
            </div>

            <div class="tags-container">
              <mat-chip-listbox class="tags-listbox" multiple [formControl]="getTagsFormControl(currentItem.form)"
                [compareWith]="compareTagsById" (selectionChange)="onChipSelectionChange($event)"
                (keydown)="onChipKeydown($event)">
                <mat-chip-option *ngFor="let tag of availableTags" [value]="tag"
                  [class.chip-selected]="isTagSelected(tag, currentItem.form)"
                  [class.chip-unselected]="!isTagSelected(tag, currentItem.form)"
                  [disabled]="getSelectedTagsCount(currentItem.form) >= 5 && !isTagSelected(tag, currentItem.form)"
                  (keydown)="onChipKeydown($event)">
                  {{tag.name}}
                </mat-chip-option>
              </mat-chip-listbox>
            </div>
          </div>



          <div class="metadata" *ngIf="currentItem.metadata && !isEditing">
            <div *ngFor="let item of currentItem.metadata | keyvalue" class="metadata-item">
              <strong *ngIf="item && item.key && item.value">{{ item.key.toUpperCase() }}:</strong> {{ item.value }}
            </div>
            <div *ngIf="currentItem.tags && currentItem.tags.length > 0 && !isEditing" class="tags-section-static">
              <h4>Areas de la oferta</h4>
              <div class="tags-container">
                <mat-chip-listbox class="tags-listbox" (keydown)="onChipKeydown($event)">
                  <mat-chip class="chip-info" *ngFor="let tag of currentItem.tags" (click)="onChipClickHandler(tag)"
                    (keydown)="onChipKeydown($event)">
                    {{tag.name}}
                  </mat-chip>
                </mat-chip-listbox>
              </div>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions *ngIf="currentItem.actions && currentItem.actions.length > 0 && !isEditing">
          <button *ngFor="let action of currentItem.actions" mat-raised-button [color]="action.color || 'primary'"
            (click)="executeAction(action)">
            <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
            {{ action.label }}
          </button>
        </mat-card-actions>
      </mat-card>

      <mat-card *ngIf="currentItem && !currentItem.editable">
        <mat-card-title>{{ currentItem.title }}</mat-card-title>
        <mat-card-header>
          <mat-card-subtitle *ngIf="currentItem.subtitle">
            {{ currentItem.subtitle }}
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content
          [ngClass]="{'invisible': panelOpenState && currentItem.candidates && currentItem.candidates.length > 0}">
          <div [innerHTML]="currentItem.content"></div>
          <div class="metadata" *ngIf="currentItem.metadata">
            <div *ngIf="currentItem.tags && currentItem.tags.length > 0 && !isEditing " class="tags-section-static">
              <h4>Areas de la oferta</h4>
              <div class="tags-container">
                <mat-chip-listbox class="tags-listbox" (keydown)="onChipKeydown($event)">
                  <mat-chip class="chip-info" *ngFor="let tag of currentItem.tags" (click)="onChipClickHandler(tag)"
                    (keydown)="onChipKeydown($event)">
                    {{tag.name}}
                  </mat-chip>
                </mat-chip-listbox>
              </div>
            </div>
            <div *ngFor="let item of currentItem.metadata | keyvalue" class="metadata-item">
              <strong>{{ item.key.toUpperCase() }}:</strong> {{ item.value }}
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions *ngIf="currentItem.actions && currentItem.actions.length > 0 && !isEditing">
          <button *ngFor="let action of currentItem.actions" mat-raised-button [color]="action.color || 'primary'"
            (click)="executeAction(action)">
            <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
            {{ action.label }}
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>